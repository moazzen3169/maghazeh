<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>مدیریت محصولات ناموجود</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@6.9.96/css/materialdesignicons.min.css">
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
<style>
:root {
  /* رنگ‌های اصلی */
  --primary: #4361ee;
  --primary-dark: #3a56d4;
  --primary-light: #eef2ff;
  --secondary: #6c757d;
  --success: #0ca678;
  --danger: #fa5252;
  --warning: #f59f00;
  --info: #339af0;
  
  /* رنگ‌های حالت روشن */
  --bg: #f8f9fa;
  --card: #ffffff;
  --border: #e9ecef;
  --ink: #212529;
  --muted: #6c757d;
  --surface: #ffffff;
  --hover: #f1f3f5;
  
  /* سایه‌ها */
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
  --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
  
  /* سایر متغیرها */
  --radius: 12px;
  --radius-sm: 8px;
  --transition: all 0.2s ease;
}

[data-theme="dark"] {
  --primary: #5a72e0;
  --primary-dark: #4c67d3;
  --primary-light: #2d3748;
  --secondary: #94a3b8;
  --success: #0da271;
  --danger: #f87171;
  --warning: #f59e0b;
  --info: #60a5fa;
  
  --bg: #0f172a;
  --card: #1e293b;
  --border: #334155;
  --ink: #f1f5f9;
  --muted: #94a3b8;
  --surface: #1e293b;
  --hover: #2d3748;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  margin: 0;
  font-family:peyda;
  background: var(--bg);
  color: var(--ink);
  line-height: 1.6;
  font-size: 15px;
  transition: var(--transition);
  min-height: 100vh;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px 16px;
}

/* ===== Header ===== */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--card);
  padding: 16px 24px;
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
  margin-bottom: 24px;
  position: sticky;
  top: 12px;
  z-index: 100;
  transition: var(--transition);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 16px;
}

.logo {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--primary);
  color: white;
  border-radius: 10px;
  font-weight: bold;
}

h1 {
  margin: 0;
  font-size: 20px;
  font-weight: 700;
}

.sub {
  font-size: 13px;
  color: var(--muted);
}

.toolbar {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

/* ===== Buttons ===== */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  border: none;
  cursor: pointer;
  border-radius: var(--radius-sm);
  padding: 10px 16px;
  font-size: 14px;
  font-weight: 500;
  background: var(--primary);
  color: #fff;
  transition: var(--transition);
  font-family: inherit;
}

.btn:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.btn-outline {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--ink);
}

.btn-outline:hover {
  background: var(--hover);
  transform: none;
  box-shadow: none;
}

.btn-icon {
  padding: 10px;
}

.btn-sm {
  padding: 6px 12px;
  font-size: 13px;
}

.btn-success {
  background: var(--success);
}

.btn-success:hover {
  background: #099268;
}

.btn-danger {
  background: var(--danger);
}

.btn-danger:hover {
  background: #e03131;
}

/* ===== Cards ===== */
.card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
  margin-bottom: 24px;
  overflow: hidden;
  transition: var(--transition);
}

.card:hover {
  box-shadow: var(--shadow-md);
}

.card-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card-title {
  font-size: 16px;
  font-weight: 600;
  margin: 0;
}

.card-body {
  padding: 20px;
}

/* ===== Form ===== */
.form-group {
  margin-bottom: 16px;
}

.form-label {
  display: block;
  font-size: 13px;
  font-weight: 500;
  margin-bottom: 6px;
  color: var(--ink);
}

.form-control {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 14px;
  background: var(--card);
  color: var(--ink);
  transition: var(--transition);
  font-family: inherit;
}

.form-control:focus {
  border-color: var(--primary);
  outline: none;
  box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
}

/* Auto-complete */
.autocomplete-wrapper {
  position: relative;
}

.autocomplete-list {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  margin-top: 4px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 50;
  box-shadow: var(--shadow-lg);
}

.autocomplete-item {
  padding: 12px 16px;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  flex-direction: column;
}

.autocomplete-item:hover {
  background: var(--hover);
}

.autocomplete-item .name {
  font-weight: 500;
}

.autocomplete-item .id {
  font-size: 12px;
  color: var(--muted);
}

/* Options & Sizes */
.options-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 8px;
}

.option-item {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--surface);
  cursor: pointer;
  font-size: 13px;
  transition: var(--transition);
}

.option-item:hover {
  border-color: var(--primary);
  background: var(--primary-light);
}

.option-item input {
  display: none;
}

.option-item.selected {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.sizes-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 12px;
}

.size-group {
  background: var(--surface);
  padding: 12px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
}

.size-group-title {
  font-weight: 500;
  margin-bottom: 8px;
  font-size: 14px;
}

.sizes-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

/* ===== Table ===== */
.table-responsive {
  overflow-x: auto;
  margin-top: 16px;
}

.table {
  width: 100%;
  border-collapse: collapse;
}

.table th {
  text-align: right;
  padding: 12px 16px;
  background: var(--surface);
  font-size: 13px;
  font-weight: 600;
  color: var(--muted);
  border-bottom: 1px solid var(--border);
}

.table td {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
}

.table tbody tr {
  transition: var(--transition);
}

.table tbody tr:hover {
  background: var(--hover);
}

/* Chips */
.chips-container {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 16px;
}

.chip {
  display: inline-flex;
  align-items: center;
  padding: 6px 12px;
  border-radius: 16px;
  background: var(--primary-light);
  color: var(--primary);
  font-size: 13px;
  font-weight: 500;
}

.chip i {
  font-size: 16px;
  margin-left: 4px;
  cursor: pointer;
}

.chip i:hover {
  opacity: 0.7;
}

/* Toast */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: var(--card);
  color: var(--ink);
  padding: 12px 16px;
  border-radius: var(--radius);
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: center;
  gap: 8px;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.3s ease;
  z-index: 1000;
  max-width: 350px;
}

.toast.show {
  opacity: 1;
  transform: translateY(0);
}

.toast-success {
  border-right: 3px solid var(--success);
}

.toast-error {
  border-right: 3px solid var(--danger);
}

/* Empty state */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--muted);
}

.empty-state i {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-state p {
  margin-top: 8px;
  font-size: 14px;
}

/* Form actions */
.form-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 16px;
}

/* Tabs */
.tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
  margin-bottom: 16px;
}

.tab {
  padding: 12px 16px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  color: var(--muted);
  border-bottom: 2px solid transparent;
  transition: var(--transition);
}

.tab.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* Utilities */
.text-muted {
  color: var(--muted);
}

.mb-2 {
  margin-bottom: 8px;
}

.mb-3 {
  margin-bottom: 16px;
}

.mt-2 {
  margin-top: 8px;
}

.mt-3 {
  margin-top: 16px;
}

.d-flex {
  display: flex;
}

.align-center {
  align-items: center;
}

.justify-between {
  justify-content: space-between;
}

.gap-2 {
  gap: 8px;
}

/* Print */
@media print {
  body { background: #fff; color: #000; }
  header, .form-section, .toolbar, .chips-container { display: none !important; }
  .card { box-shadow: none; border: none; }
  #invoiceSection { display: block !important; }
  #printHeader {
    display: block !important;
    margin-bottom: 20px;
    text-align: center;
  }
}
#printHeader { display: none; }

/* Responsive */
@media (max-width: 768px) {
  .container {
    padding: 16px 12px;
  }
  
  header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
  }
  
  .toolbar {
    width: 100%;
    justify-content: flex-end;
  }
  
  .btn {
    padding: 8px 12px;
    font-size: 13px;
  }
  
  .card-body {
    padding: 16px;
  }
  
  .table th, .table td {
    padding: 12px;
  }
}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-left">
        <div class="logo">
          <i class="mdi mdi-package-variant"></i>
        </div>
        <div>
          <h1>مدیریت محصولات ناموجود</h1>
          <div class="sub">تاریخ: <span id="today"></span></div>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn btn-outline" id="darkModeBtn">
          <i class="mdi mdi-theme-light-dark"></i>
          <span>تغییر تم</span>
        </button>
        <button class="btn btn-outline" id="printBtn">
          <i class="mdi mdi-printer"></i>
          <span>چاپ</span>
        </button>
        <button class="btn" id="exportBtn">
          <i class="mdi mdi-download"></i>
          <span>خروجی JSON</span>
        </button>
      </div>
    </header>

    <div class="tabs">
      <div class="tab active" data-tab="form">افزودن محصول</div>
      <div class="tab" data-tab="list">لیست محصولات</div>
    </div>

    <!-- فرم محصولات -->
    <section class="card form-section tab-content active" id="formTab">
      <div class="card-header">
        <h2 class="card-title">افزودن محصول ناموجود</h2>
        <button class="btn btn-sm" id="addFormBtn">
          <i class="mdi mdi-plus"></i>
          فرم جدید
        </button>
      </div>
      <div class="card-body" id="formsWrap"></div>
    </section>

    <!-- لیست محصولات -->
    <section class="card tab-content" id="listTab">
      <div class="card-header">
        <h2 class="card-title">لیست محصولات ناموجود</h2>
        <div class="d-flex align-center gap-2">
          <div class="form-control" style="width: auto; padding: 6px 12px;">
            <i class="mdi mdi-magnify"></i>
          </div>
          <div class="text-muted">تعداد: <span id="itemsCount">0</span></div>
        </div>
      </div>
      <div class="card-body">
        <div id="emptyState" class="empty-state">
          <i class="mdi mdi-package-variant-remove"></i>
          <h3>محصولی یافت نشد</h3>
          <p>هنوز محصولی به لیست اضافه نکرده‌اید</p>
        </div>
        <div class="table-responsive">
          <table class="table" id="invoiceTable" style="display:none">
            <thead>
              <tr>
                <th>#</th>
                <th>محصول</th>
                <th>رنگ‌ها</th>
                <th>سایزها</th>
                <th>عملیات</th>
              </tr>
            </thead>
            <tbody id="invoiceBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- سربرگ چاپ -->
    <div id="printHeader">
      <h2>شرکت XYZ</h2>
      <p>صورت جلسه موجودی ناموجود - <span id="printDate"></span></p>
      <p>امضا مسئول انبار: ..................................</p>
    </div>
  </div>

  <!-- قالب فرم -->
  <template id="productFormTpl">
    <div class="card" style="margin-bottom:16px">
      <div class="card-body">
        <div class="form-group">
          <label class="form-label">جستجوی محصول</label>
          <div class="autocomplete-wrapper">
            <input type="text" class="form-control productInput" placeholder="نام یا کد محصول را جستجو کنید..." />
            <div class="autocomplete-list"></div>
          </div>
          <div class="text-muted mt-2 productError" style="color: var(--danger) !important;"></div>
        </div>
        
        <div class="form-group">
          <label class="form-label">انتخاب رنگ‌ها</label>
          <div class="options-grid colorsOpts"></div>
          <div class="text-muted mt-2 colorError" style="color: var(--danger) !important;"></div>
        </div>
        
        <div class="form-group">
          <label class="form-label">انتخاب سایزها</label>
          <div class="sizes-container"></div>
          <div class="text-muted mt-2 sizeError" style="color: var(--danger) !important;"></div>
        </div>
        
        <div class="form-actions">
          <button class="btn addToList">
            <i class="mdi mdi-check"></i>
            افزودن به لیست
          </button>
          <button class="btn btn-outline resetForm">
            <i class="mdi mdi-autorenew"></i>
            پاکسازی
          </button>
          <button class="btn btn-outline btn-danger removeForm">
            <i class="mdi mdi-delete"></i>
            حذف فرم
          </button>
        </div>
      </div>
    </div>
  </template>

  <div class="toast toast-success" id="toast">
    <i class="mdi mdi-check-circle"></i>
    <div id="toastMessage"></div>
  </div>

  <script>
    const STANDARD_SIZES = ["36","38","40","42","44","46","48","50","52","54","56","58","60"];
    const CATALOG = [
      { id:"P-1101", name:"تی‌شرت ساده", colors:["مشکی","سفید","سرمه‌ای"] },
      { id:"P-2203", name:"هودی کلاسیک", colors:["مشکی","کرم","سبز"] },
      { id:"P-3302", name:"شلوار جین", colors:["آبی روشن","آبی تیره"] },
      { id:"P-4405", name:"پلیور مردانه", colors:["مشکی","خاکستری","نavy"] },
      { id:"P-5501", name:"ژاکت زمستانی", colors:["قهوه‌ای","بژ","مشکی"] },
    ];
    
    let state = { items:[] };

    function jalaliToday(){
      try { return new Intl.DateTimeFormat("fa-IR",{dateStyle:"medium"}).format(new Date()); }
      catch { return new Date().toLocaleDateString("fa-IR"); }
    }
    document.getElementById("today").textContent = jalaliToday();
    document.getElementById("printDate").textContent = jalaliToday();

    const formsWrap = document.getElementById("formsWrap");
    const tpl = document.getElementById("productFormTpl");
    const toast = document.getElementById("toast");
    const toastMessage = document.getElementById("toastMessage");

    function showToast(msg, type = "success"){
      toastMessage.textContent = msg;
      toast.className = `toast toast-${type}`;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    function createForm(item = null){
      const node = tpl.content.cloneNode(true);
      const el = node.querySelector(".card");
      const productInput = el.querySelector(".productInput");
      const autoList = el.querySelector(".autocomplete-list");
      const colorsOpts = el.querySelector(".colorsOpts");
      const sizesContainer = el.querySelector(".sizes-container");
      const productError = el.querySelector(".productError");
      const colorError = el.querySelector(".colorError");
      const sizeError = el.querySelector(".sizeError");

      let selectedProduct = null;

      function showSuggestions(value){
        autoList.innerHTML = "";
        if(!value) return;
        
        const results = CATALOG.filter(p => 
          p.name.includes(value) || p.id.includes(value)
        );
        
        if(results.length === 0) {
          const div = document.createElement("div");
          div.className = "autocomplete-item";
          div.textContent = "نتیجه‌ای یافت نشد";
          autoList.appendChild(div);
          return;
        }
        
        results.forEach(p => {
          const div = document.createElement("div");
          div.className = "autocomplete-item";
          div.innerHTML = `
            <div class="name">${p.name}</div>
            <div class="id">${p.id}</div>
          `;
          div.onclick = () => {
            productInput.value = p.name;
            selectedProduct = p;
            autoList.innerHTML = "";
            renderColors();
          };
          autoList.appendChild(div);
        });
      }

      productInput.addEventListener("input", e => {
        selectedProduct = null;
        colorsOpts.innerHTML = "";
        sizesContainer.innerHTML = "";
        showSuggestions(e.target.value.trim());
      });

      productInput.addEventListener("focus", () => {
        if(productInput.value.trim() && !selectedProduct) {
          showSuggestions(productInput.value.trim());
        }
      });

      document.addEventListener("click", (e) => {
        if(!el.contains(e.target)) {
          autoList.innerHTML = "";
        }
      });

      function renderColors(){
        colorsOpts.innerHTML = "";
        sizesContainer.innerHTML = "";
        if(!selectedProduct) return;
        
        selectedProduct.colors.forEach(c => {
          const option = document.createElement("div");
          option.className = "option-item";
          option.textContent = c;
          option.dataset.value = c;
          option.addEventListener("click", () => {
            option.classList.toggle("selected");
            updateSizes();
          });
          colorsOpts.appendChild(option);
        });
      }

      function updateSizes(){
        sizesContainer.innerHTML = "";
        const selectedColors = [...colorsOpts.querySelectorAll(".option-item.selected")];
        
        if(selectedColors.length === 0) return;
        
        selectedColors.forEach(colorEl => {
          const color = colorEl.dataset.value;
          const group = document.createElement("div");
          group.className = "size-group";
          
          const title = document.createElement("div");
          title.className = "size-group-title";
          title.textContent = color;
          group.appendChild(title);
          
          const sizesGrid = document.createElement("div");
          sizesGrid.className = "sizes-grid";
          
          STANDARD_SIZES.forEach(s => {
            const sizeOption = document.createElement("div");
            sizeOption.className = "option-item";
            sizeOption.textContent = s;
            sizeOption.dataset.value = s;
            sizeOption.addEventListener("click", () => {
              sizeOption.classList.toggle("selected");
            });
            sizesGrid.appendChild(sizeOption);
          });
          
          group.appendChild(sizesGrid);
          sizesContainer.appendChild(group);
        });
      }

      el.querySelector(".resetForm").addEventListener("click", () => {
        productInput.value = "";
        selectedProduct = null;
        colorsOpts.innerHTML = "";
        sizesContainer.innerHTML = "";
        productError.textContent = "";
        colorError.textContent = "";
        sizeError.textContent = "";
      });
      
      el.querySelector(".removeForm").addEventListener("click", () => {
        el.remove();
      });

      el.querySelector(".addToList").addEventListener("click", () => {
        productError.textContent = colorError.textContent = sizeError.textContent = "";
        
        // اعتبارسنجی محصول
        if(!selectedProduct){
          productError.textContent = "لطفاً یک محصول انتخاب کنید";
          return;
        }
        
        // اعتبارسنجی رنگ‌ها
        const selectedColors = [...colorsOpts.querySelectorAll(".option-item.selected")].map(el => el.dataset.value);
        if(selectedColors.length === 0){
          colorError.textContent = "لطفاً حداقل یک رنگ انتخاب کنید";
          return;
        }
        
        // اعتبارسنجی سایزها
        const sizesByColor = {};
        let hasError = false;
        
        selectedColors.forEach(color => {
          const colorGroup = [...sizesContainer.querySelectorAll(".size-group")].find(
            group => group.querySelector(".size-group-title").textContent === color
          );
          
          if(colorGroup){
            const selectedSizes = [...colorGroup.querySelectorAll(".option-item.selected")].map(
              el => el.dataset.value
            );
            
            if(selectedSizes.length === 0){
              hasError = true;
              sizeError.textContent = "برای هر رنگ حداقل یک سایز انتخاب کنید";
            } else {
              sizesByColor[color] = selectedSizes;
            }
          }
        });
        
        if(hasError) return;
        
        // افزودن به state
        const entry = {
          id: crypto.randomUUID(),
          productId: selectedProduct.id,
          productName: selectedProduct.name,
          colors: selectedColors,
          sizesByColor
        };
        
        state.items.push(entry);
        saveState();
        renderInvoice();
        showToast("محصول با موفقیت به لیست اضافه شد");
        
        // پاکسازی فرم
        productInput.value = "";
        selectedProduct = null;
        colorsOpts.innerHTML = "";
        sizesContainer.innerHTML = "";
      });

      // حالت ویرایش
      if(item){
        selectedProduct = CATALOG.find(p => p.id === item.productId);
        productInput.value = selectedProduct.name;
        
        // رندر رنگ‌ها
        renderColors();
        
        // انتخاب رنگ‌های قبلی
        setTimeout(() => {
          item.colors.forEach(color => {
            const colorEl = [...colorsOpts.querySelectorAll(".option-item")].find(
              el => el.dataset.value === color
            );
            if(colorEl) colorEl.classList.add("selected");
          });
          
          // به روزرسانی سایزها
          updateSizes();
          
          // انتخاب سایزهای قبلی
          setTimeout(() => {
            Object.entries(item.sizesByColor).forEach(([color, sizes]) => {
              const colorGroup = [...sizesContainer.querySelectorAll(".size-group")].find(
                group => group.querySelector(".size-group-title").textContent === color
              );
              
              if(colorGroup){
                sizes.forEach(size => {
                  const sizeEl = [...colorGroup.querySelectorAll(".option-item")].find(
                    el => el.dataset.value === size
                  );
                  if(sizeEl) sizeEl.classList.add("selected");
                });
              }
            });
          }, 100);
        }, 100);
      }

      formsWrap.appendChild(el);
    }

    function renderInvoice(){
      const body = document.getElementById("invoiceBody");
      const table = document.getElementById("invoiceTable");
      const empty = document.getElementById("emptyState");
      const itemsCount = document.getElementById("itemsCount");
      
      body.innerHTML = "";
      itemsCount.textContent = state.items.length;
      
      if(state.items.length === 0){
        table.style.display = "none";
        empty.style.display = "block";
        return;
      }
      
      table.style.display = "table";
      empty.style.display = "none";
      
      state.items.forEach((it, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>
            <div>${it.productName}</div>
            <div class="text-muted">${it.productId}</div>
          </td>
          <td>${it.colors.join("، ")}</td>
          <td>${it.colors.map(c => `<b>${c}:</b> ${it.sizesByColor[c].join("، ")}`).join("<br>")}</td>
          <td>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline" data-act="edit" data-id="${it.id}">
                <i class="mdi mdi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline btn-danger" data-act="del" data-id="${it.id}">
                <i class="mdi mdi-delete"></i>
              </button>
            </div>
          </td>
        `;
        body.appendChild(tr);
      });
    }

    document.getElementById("invoiceBody").addEventListener("click", e => {
      const btn = e.target.closest("button");
      if(!btn) return;
      
      const id = btn.dataset.id;
      const act = btn.dataset.act;
      const idx = state.items.findIndex(x => x.id === id);
      
      if(idx === -1) return;
      
      if(act === "del"){
        state.items.splice(idx, 1);
        saveState();
        renderInvoice();
        showToast("محصول از لیست حذف شد");
      } else if(act === "edit"){
        createForm(state.items[idx]);
        state.items.splice(idx, 1);
        saveState();
        renderInvoice();
        document.querySelector('[data-tab="form"]').click();
      }
    });

    // Tab functionality
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        // Remove active class from all tabs and contents
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        
        // Add active class to clicked tab and corresponding content
        tab.classList.add("active");
        document.getElementById(`${tab.dataset.tab}Tab`).classList.add("active");
      });
    });

    document.getElementById("addFormBtn").addEventListener("click", () => createForm());
    document.getElementById("printBtn").addEventListener("click", () => window.print());
    
    document.getElementById("exportBtn").addEventListener("click", () => {
      const data = JSON.stringify({date: jalaliToday(), items: state.items}, null, 2);
      const blob = new Blob([data], {type: "application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `products-${new Date().getTime()}.json`;
      a.click();
      showToast("فایل JSON با موفقیت دانلود شد");
    });
    
    document.getElementById("darkModeBtn").addEventListener("click", () => {
      const isDark = document.body.dataset.theme === "dark";
      document.body.dataset.theme = isDark ? "" : "dark";
      localStorage.setItem("theme", isDark ? "light" : "dark");
    });

    function saveState(){
      localStorage.setItem("unavailableProducts", JSON.stringify(state.items));
    }
    
    function loadState(){
      const data = localStorage.getItem("unavailableProducts");
      if(data) state.items = JSON.parse(data);
      
      const savedTheme = localStorage.getItem("theme");
      if(savedTheme === "dark") document.body.dataset.theme = "dark";
    }



    function generatePrintTables() {
  const container = document.getElementById("printHeader");
  container.innerHTML = `
    <h2>شرکت XYZ</h2>
    <p>صورت جلسه موجودی ناموجود - <span id="printDate">${jalaliToday()}</span></p>
    <p>امضا مسئول انبار: ..................................</p>
  `;

  if (state.items.length === 0) {
    container.innerHTML += `<p style="color:red; text-align:center;">⚠️ محصولی برای چاپ وجود ندارد</p>`;
    return;
  }

  // ایجاد جدول اصلی یک‌بار
  const table = document.createElement("table");
  Object.assign(table.style, {
    width: "100%", border: "1px solid black",
    borderCollapse: "collapse", marginTop: "20px"
  });

  state.items.forEach(item => {
    item.colors.forEach((color, idx) => {
      const tr = document.createElement("tr");

      // ستون سایزها (با ویرگول)
      const sizesTd = document.createElement("td");
      sizesTd.style.border = "1px solid black";
      sizesTd.style.padding = "8px";
      sizesTd.textContent = item.sizesByColor[color].join("، ");
      tr.appendChild(sizesTd);

      // ستون رنگ
      const colorTd = document.createElement("td");
      colorTd.style.border = "1px solid black";
      colorTd.style.padding = "8px";
      colorTd.textContent = color;
      tr.appendChild(colorTd);

      // ستون محصول (فقط در اولین ردیف آن محصول)
      if (idx === 0) {
        const productTd = document.createElement("td");
        productTd.style.border = "1px solid black";
        productTd.style.padding = "8px";
        productTd.textContent = item.productName;
        productTd.rowSpan = item.colors.length;
        tr.appendChild(productTd);
      }

      table.appendChild(tr);
    });
  });

  container.appendChild(table);
}

// دکمه چاپ
document.getElementById("printBtn").addEventListener("click", () => {
  generatePrintTables();
  window.print();
});

    // Initialize
    loadState();
    renderInvoice();
    createForm();


  </script>
</body>
</html>